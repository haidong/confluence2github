:::::::::::: {#page}
:::::::: {#main .aui-page-panel}
:::: {#main-header}
::: {#breadcrumb-section}
1.  [Alex Ji](index.html)
2.  [Alex Ji's Home](377815074.html)
3.  [Create EKS cluster node
    group](Create-EKS-cluster-node-group_387686974.html)
:::

# [ Alex Ji : Setup EBS CSI driver for k8s Persistent Volume Claim ]{#title-text} {#title-heading .pagetitle}
::::

::::: {#content .view}
::: page-metadata
Created by [ Alex Ji]{.author}, last modified on Feb 03, 2024
:::

::: {#main-content .wiki-content .group}
Our demo cluster has MySQL and Oracle instances that uses EBS volumes
for storage. During transitioning of nodes from one group to another for
demo-dev cluster, I noticed[ 2 statefulsets (mysqlDB and oracleDB) were
sitting in pending status. This is due to the EBS volumes cannot be
mounted to the new worker nodes. To resolve, I proceeded with the
installation of the EBS CSI driver addon in the demo-dev
EKS.]{style="color: rgb(22,25,31);"}

[AWS has the documentation here:
[https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html](https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html){.external-link
rel="nofollow"}. There are two major steps
needed:]{style="color: rgb(22,25,31);"}

-   [Create IAM role that\'s associated with this
    cluster]{style="color: rgb(22,25,31);"}
-   [Proceed with driver installation]{style="color: rgb(22,25,31);"}

## [Create IAM role that\'s associated with this cluster]{style="color: rgb(22,25,31);"} {#SetupEBSCSIdriverfork8sPersistentVolumeClaim-CreateIAMrolethat'sassociatedwiththiscluster}

[I created `AmazonEKS_EBS_CSI_DriverRole` role when I tried moving the
demo-dev cluster to a new node group, following the instructions
described here:
[https://docs.aws.amazon.com/eks/latest/userguide/csi-iam-role.html](https://docs.aws.amazon.com/eks/latest/userguide/csi-iam-role.html){.external-link
rel="nofollow"}. As of this writing, the linked article has a tab of
using `eksctl`, which I tried to follow. However, perhaps due to the
cluster was first created a while ago, the `eksctl` command didn\'t
work. So I used the instruction under the \"AWS CLI\" tab
instead.]{style="color: rgb(22,25,31);"}

For reference, here is the role definition I used:

`{`\
`  "Version": "2012-10-17",`\
`  "Statement": [`\
`    {`\
`      "Effect": "Allow",`\
`      "Principal": {`\
`        "Federated": "arn:aws:iam::632713433352:oidc-provider/`[`oidc.eks.us-west-2.amazonaws.com/id/9DDD2F457AC46E2C25A6DA0F4CC5C5C1`](http://oidc.eks.us-west-2.amazonaws.com/id/9DDD2F457AC46E2C25A6DA0F4CC5C5C1){.external-link
rel="nofollow"}`"`\
`      },`\
`      "Action": "sts:AssumeRoleWithWebIdentity",`\
`      "Condition": {`\
`        "StringEquals": {`\
`          "`[`oidc.eks.us-west-2.amazonaws.com/id/9DDD2F457AC46E2C25A6DA0F4CC5C5C1:aud`](http://oidc.eks.us-west-2.amazonaws.com/id/9DDD2F457AC46E2C25A6DA0F4CC5C5C1:aud){.external-link
rel="nofollow"}`": "`[`sts.amazonaws.com`](http://sts.amazonaws.com){.external-link
rel="nofollow"}`",`\
`          "`[`oidc.eks.us-west-2.amazonaws.com/id/9DDD2F457AC46E2C25A6DA0F4CC5C5C1:sub`](http://oidc.eks.us-west-2.amazonaws.com/id/9DDD2F457AC46E2C25A6DA0F4CC5C5C1:sub){.external-link
rel="nofollow"}`": "system:serviceaccount:kube-system:ebs-csi-controller-sa"`\
`        }`\
`      }`\
`    }`\
`  ]`\
`}`

The detailed instruction can be found here:
[https://docs.aws.amazon.com/eks/latest/userguide/csi-iam-role.html](https://docs.aws.amazon.com/eks/latest/userguide/csi-iam-role.html){.external-link
rel="nofollow"}, except the step of custom KMS key is un-necessary.

## [Create the addon]{style="color: rgb(22,25,31);"} {#SetupEBSCSIdriverfork8sPersistentVolumeClaim-Createtheaddon}

[For demo-dev, the addon was created using the web console: EKS cluster
page and then Add-ons tab. But the CLI below should also
work:]{style="color: rgb(22,25,31);"}

[`aws eks create-addon --cluster-name demo-west-appdcloud-demo4 --addon-name aws-ebs-csi-driver \                                                                                              `\
`  --service-account-role-arn arn:aws:iam::632713433352:role/AmazonEKS_EBS_CSI_DriverRole_Demo4`]{style="color: rgb(22,25,31);"}
:::
:::::
::::::::

::::: {#footer role="contentinfo"}
:::: {.section .footer-body}
Document generated by Confluence on May 22, 2024 14:04

::: {#footer-logo}
[Atlassian](https://www.atlassian.com/)
:::
::::
:::::
::::::::::::
